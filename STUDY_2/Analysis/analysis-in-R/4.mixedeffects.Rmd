---
title: "Mixed Effects Analysis"
output: html_notebook
---
*NOTE: Data is imported from all_participants.csv*
```{r echo = FALSE}
#SETUP DATA FRAMES

#import libraries
library(readr) #load csv
library(dplyr) #data formatting
library(ggplot2) #graphing
library(psych)   #statistics
library(pastecs)
#library(gridExtra)
library(Hmisc)
library(reshape2) #reformatting data
#library(tables) # pretty tables
library(ez) #mixed anova
library(nlme) #multilevel model
library(WRS2) #robust tests

#load data from csv
all_participants <- read_csv("~/Sites/RESEARCH/2YP-Analysis/xls-files/master-wrangled-data/all_participants.csv", 
    col_types = cols(AGE = col_integer()))


#define labels for experiment order
order_labels <- c(regular = "linear-first", reverse = "triangular-first")
condition_lables <-c( '0' = "no scaffold", '1' = "'what' text", '2' = "'how' text", '3' = "static image", '4' = "interactive image")
task_labels <- c("LM_T_M" = "linear graph", "TM_T_M" = "triangular graph")

#create copy data of base data frame 
df_participantData <- cbind(all_participants)

#create new column with participant order labels
order <- df_participantData$experiment
order[order == "experiment"] <- "regular"
df_participantData$order <- order

#create data subsets
df_subjects <- filter(df_participantData, condition == 0 | condition == 1 |  condition == 2 |condition == 3 | condition == 4 )
df_experts <- filter(df_participantData, condition == 'e0' | condition == 'e4' ) 
df_regular <- subset(df_subjects, order=="regular")
df_reverse <- subset(df_subjects, order=="reverse")

```

```{r echo = FALSE}
  red = "#F8766D"
  green = "#1cc07e"
  blue = "#59A1FC"
  purple = "#C680FD"
```

####Mixed Designs Analysis
The experimental design consists of 1 within-subjects factor (graph) with two levels (linear, triangular), and two between-subjects factors: scaffold condition (5 levels: no scaffold, 'what' text, 'how' text, static image, interactive image) and task order (linear-first, triangular-first). 

```{r echo = FALSE}
#1. Enter data
# our data df_subjects is in wide format (repeated measures in different columns), however we need it in long format
w_times = subset(df_subjects, select = c("subject","condition", "order", "lm_scenarios", "LM_T_M","TM_T_M")) #create a wide form subset 
l_times <-melt(w_times, id=c("subject","condition", "order", "lm_scenarios"), measured=c("LM_T_M","TM_T_M")) 
#convert other variables to factors
l_times$condition <- factor(l_times$condition)
l_times$order <- factor(l_times$order)
l_times$lm_scenarios <- factor(l_times$lm_scenarios)

#2. Explore data
#create boxplot

#SIMPLE BOXPLOT BY CONDITION
#mixedPlot_condition <- ggplot(l_times, aes(condition,value, color=variable))+ geom_boxplot() + 
#  labs(x="scaffold condition", y="time (minutes)") + 
#  ggtitle("Task Response Time by Scaffold ") +
#  theme_bw() 
#mixedPlot_condition
  
#BOXPLOT BY CONDITION, FACET WITH ORDER
mixedPlot_order <- ggplot(l_times, aes(condition,value, fill=variable))+ geom_boxplot() +
  facet_wrap(~order, labeller=labeller(order = order_labels)) +
  labs(x="scaffold condition", y="time (minutes)", color="task")+ 
  ggtitle("Task Response Time by Scaffold & Task Order ") +
  theme_bw() +
  theme(strip.background = element_blank()) +
  scale_fill_manual( values = c(green,red),
                       name="graphing task",
                       breaks=c("LM_T_M", "TM_T_M"),
                       labels=c("linear", "triangular"))
  #use scale_fill_manual to manually change colors 
                      
mixedPlot_order

#BOXPLOT BY CONDITION, FACET WITH ORDER AND SCENARIO
#mixedPlot_scenario <- ggplot(l_times, aes(condition,value, color=variable))+ geom_boxplot() + 
#  facet_grid(lm_scenarios~order, labeller=labeller(order = order_labels)) +
#  theme_bw() +
#  theme(strip.background = element_blank()) +
#  labs(x="scaffold condition", y="time (minutes)")+ 
#  ggtitle("Task Response Time by Scaffold, Task Order and Scenario ") 
#mixedPlot_scenario
``` 

```{r echo = FALSE}
#explore descriptive statistics based on each IV
#by(l_times$value, list(l_times$condition, l_times$order, l_times$variable), stat.desc, basic=FALSE)
```

3. Construct contrasts
```{r echo = FALSE}
#construct contrasts for ANOVA model
lmVStm <-c(1,-1)
contrasts(l_times$variable) <- cbind(lmVStm)
expVSrev<-c(1,-1)
contrasts(l_times$order) <- cbind(lmVStm)
scaffVSold<-c(-4,1,1,1,1)
contrasts(l_times$condition) <- cbind(scaffVSold)
```
4. Compute main model ANOVA
```{r echo = FALSE}

options(contrasts=c("contr.sum","contr.poly"))

#execute the model
mixedModel = ezANOVA(data = l_times,
                     dv = .(value),
                     wid = .(subject),
                     between = .(condition,order,lm_scenarios),
                     within = .(variable),
                     type = 3,
                     detailed = FALSE)
mixedModel
```
RESULTS suggest a significant main-effect of graph task, and significant interactions between condition & graph, and order and task and scenario and task.  Main effects of condition and order were not significant. 

4. Compute the Model with GLM
```{r echo = FALSE}
#build the baseline model with no predictors other than the intercept
baseline <- lme(value ~ 1, random = ~1|subject/condition/order/variable, data= l_times, method="ML")

#add expected main effects of CONDITION
graphModel <- update(baseline, .~. +variable)
#conditionModel<- update(graphModel, .~. +condition)
orderModel<- update(graphModel, .~. +order)
graph_condition <- update(orderModel, .~. +variable:condition)
condition_order <- update(graph_condition, .~. +condition:order)
graph_order <- update(condition_order, .~. +variable:order)
finalModel <- update(graph_order, .~. +variable:lm_scenarios)

anova(baseline, graphModel, conditionModel, orderModel, graph_condition, condition_order, graph_order, finalModel)
summary(orderModel)
```
Condition, GraphXCondition, GraphXOrder, GraphXScenario


```{r}
plot(finalModel)

```

5. Compute contrasts & post-hoc tests